"use strict";let overtime,overtimePlus,lastMonthPay,overalValue=5e6,overalValueMin=1e5,overalValueMax=1e8,interestRate=10;function rate(e){return e/12/100}let interestRateMin=.01,interestRateMax=25,monthPay=5e4,monthPayMin=1e3,monthPayMax=5e6,arr=[overalValue,interestRate,monthPay],arrMin=[overalValueMin,interestRateMin,monthPayMin],arrMax=[overalValueMax,interestRateMax,monthPayMax],arrFlag=[1,1,1],arrSymbols=[12,6,8],monthLimit=300,fields=document.querySelectorAll("input"),checkout=document.querySelectorAll(".small"),elem=document.querySelector("#total");function minmax(e,r,t){return t<e&&(t=e),t>r&&(t=r),t}function logab(e,r){return Math.log(e)/Math.log(r)}function numberToText(e,r){let t=Math.floor(100*e)/100,a=String(t).substr(0,r);return a=String(a),t>=1e4&&(a=String(a).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")),a=a.replace(/\.0*$/gm,""),a=a.replace(".",","),a}function textToNumber(e,r){let t=String(e).replace(/\./g,",");return t=t.replace(",","."),t=t.replace(/[^.\d]/g,""),"."==t[0]&&(t="0"+t),"0"==t[0]&&"0"==t[1]&&(t=t.substr(1,r)),t=t.substr(0,r),t=t.replace(/\.0*$/gm,""),+t}function cleanDigit(e,r){let t=e.replace(/\./g,",");return t=t.replace(",","."),t=t.replace(/[^.\d]/g,""),t=t.substr(0,r),"."==t[0]&&(t="0"+t),"0"==t[0]&&"0"==t[1]&&(t=t.substr(1,r)),t=t.replace(/^\d+\,\d{0,2}$/),t=t.replace(".",","),t}function initLoop(){for(let e=0;e<fields.length;e++)console.log("arr "+arr[e]),console.log("numberToText "+numberToText(arr[e],arrSymbols[e])),fields[e].value=numberToText(arr[e],arrSymbols[e])}function mainLoop(){for(let e=0;e<fields.length;e++)fields[e].addEventListener("focus",(function(r){arr[e]=textToNumber(fields[e].value,arrSymbols[e]),fields[e].value=antidot(textToNumber(arr[e],arrSymbols[e]))})),fields[e].addEventListener("blur",(function(r){arr[e]=textToNumber(fields[e].value,arrSymbols[e]),fields[e].value=numberToText(arr[e],arrSymbols[e]),arrFlag[e]||arbeit(e)})),fields[e].addEventListener("input",(function(r){elem.innerHTML="",arrFlag[e]=0;let t=fields[e].value;t=cleanDigit(t,arrSymbols[e]),fields[e].value=t,arr[e]=textToNumber(fields[e].value,arrSymbols[e]),buttonAct()}))}function period(){for(let e of arrFlag)arrFlag[e]=1;for(let e=0;e<fields.length;e++)arr[e]=textToNumber(fields[e].value,arrSymbols[e]),arr[e]=minmax(arrMin[e],arrMax[e],arr[e]),fields[e].value=numberToText(arr[e]);reCalc()}function reCalc(){let e;overalValue=arr[0],interestRate=arr[1],monthPay=arr[2],overtime=logab(1/(1-overalValue*rate(interestRate)/monthPay),1+rate(interestRate)),console.log("периоды "+overtime),(Number.isNaN(overtime)||overtime>monthLimit)&&(arr[2]=badNumber(),console.log("ПЕРЕСЧЕТ!!! "+arr[2]),initLoop(),reCalc()),overtimePlus=Math.ceil(overtime),console.log("(объем в целых) "+overtimePlus),lastMonthPay=Math.ceil((overtime-Math.floor(overtime))*monthPay*100)/100,e=overtimePlus%12==0?"":`${overtimePlus%12} ${textMonth(parseInt(overtimePlus%12))}`,parseInt(overtimePlus/12)?elem.innerHTML=`${parseInt(overtimePlus/12)} ${textYear(parseInt(overtimePlus/12))} ${e}`:elem.innerHTML=`${e}`,document.getElementById("comment").innerHTML="(Месяцев: "+(overtimePlus-1)+" ) X ("+noBreak(numberToText(monthPay,10))+" ежемесячно)&nbsp;= "+noBreak(numberToText((overtimePlus-1)*monthPay,10))+". И&nbsp;последний платеж: "+noBreak(numberToText(lastMonthPay,10))+". Переплата: "+noBreak(numberToText(cent((overtimePlus-1)*monthPay+lastMonthPay-overalValue)))+".<br> При расчете значения всех трех полей корректируются в соответствие с граничными параметрами. <br>Если расчетное время превысит 25 лет, будет скорректировано значение в поле ЕЖЕМЕСЯЧНЫЙ ВЗНОС.",buttonDis()}function antidot(e){return e=String(e).replace(".",",")}function dot(e){return e=+String(e).replace(",",".")}function cent(e){return Math.ceil(100*e)/100}initLoop(),mainLoop(),reCalc();const btn=document.querySelector("button");function textYear(e){let r,t=e%100;return t>=5&&t<=20?r="лет":(t%=10,r=1==t?"год":t>=2&&t<=4?"года":"лет"),r}function textMonth(e){let r;return r=1==e?"месяц":e<=4?"месяца":"месяцев",r}function noBreak(e){return e=e.replace(/ /g,"&nbsp;")}function badNumber(){return monthPay=overalValue*(rate(interestRate)*(1+rate(interestRate))**monthLimit)/((1+rate(interestRate))**monthLimit-1),monthPay=cent(monthPay),monthPay}function buttonDis(){let e=document.querySelector(".press");e.setAttribute("disabled",!0),e.classList.add("nopress")}function buttonAct(){let e=document.querySelector(".press");e.removeAttribute("disabled"),e.classList.remove("nopress")}function arbeit(e){if(console.log("arrFlag[index] "+arrFlag[e]),arrFlag[e])return;let r=4,t=checkout[e].innerHTML,a=setInterval((()=>{checkout[e].classList.add("redalert"),checkout[e].innerHTML="проверка и коррекция значения через "+(r-1)+" с",console.log("проверка и коррекция значения через "+(r-1)+" с"),r-=1,0===r&&(console.log("Done"),clearInterval(a),check(e),checkout[e].classList.remove("redalert"),checkout[e].innerHTML=t)}),1e3,e)}function check(e){arr[e]=textToNumber(fields[e].value,arrSymbols[e]),arr[e]=minmax(arrMin[e],arrMax[e],arr[e]),fields[e].value=numberToText(arr[e]),arrFlag[e]=1,console.log("ПРОВЕРКА НАЧАЛАСЬ arr[i] "+arr[e])}btn.addEventListener("click",period),console.log("badNumber "+badNumber());