"use strict";let overtime,overtimePlus,lastMonthPay,counter=4,overalValue=5e6,overalValueMin=1e5,overalValueMax=1e8,interestRate=10;function rate(e){return e/12/100}let interestRateMin=.01,interestRateMax=25,monthPay=5e4,monthPayMin=1e3,monthPayMax=5e6,arr=[overalValue,interestRate,monthPay],arrMin=[overalValueMin,interestRateMin,monthPayMin],arrMax=[overalValueMax,interestRateMax,monthPayMax],arrFlag=[1,1,1],arrSymbols=[12,5,8],monthLimit=300,fields=document.querySelectorAll("input"),checkout=document.querySelectorAll(".small"),elem=document.querySelector("#total"),formInitComment=[];for(let e=0;e<3;e++)formInitComment[e]=checkout[e].innerHTML;function minmax(e,t,r){return r<e&&(r=e),r>t&&(r=t),r}function logab(e,t){return Math.log(e)/Math.log(t)}function numberToText(e,t){let r=Math.floor(100*e)/100,n=String(r).substr(0,t);return n=String(n),r>=1e4&&(n=String(n).replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1 ")),n=n.replace(/\.0*$/gm,""),n=n.replace(".",","),n}function textToNumber(e,t){let r=String(e).replace(/\./g,",");return r=r.replace(",","."),r=r.replace(/[^.\d]/g,""),"."==r[0]&&(r="0"+r),"0"==r[0]&&"0"==r[1]&&(r=r.substr(1,t)),r=r.substr(0,t),r=r.replace(/\.0*$/gm,""),+r}function cleanDigit(e,t){let r=e.replace(/\./g,",");return r=r.replace(",","."),r=r.replace(/[^.\d]/g,""),r=r.substr(0,t),"."==r[0]&&(r="0"+r),"0"==r[0]&&"0"==r[1]&&(r=r.substr(1,t)),r=r.replace(/^\d+\,\d{0,2}$/),r=r.replace(".",","),r}function initLoop(){for(let e=0;e<fields.length;e++)fields[e].value=numberToText(arr[e],arrSymbols[e])}function mainLoop(){for(let e=0;e<fields.length;e++)fields[e].addEventListener("focus",(function(t){arr[e]=textToNumber(fields[e].value,arrSymbols[e]),fields[e].value=antidot(textToNumber(arr[e],arrSymbols[e]))})),fields[e].addEventListener("blur",(function(t){counter=4,arr[e]=textToNumber(fields[e].value,arrSymbols[e]),fields[e].value=numberToText(arr[e],arrSymbols[e]),arrFlag[e]||arbeit(e)})),fields[e].addEventListener("input",(function(t){elem.innerHTML="",arrFlag[e]=0;let r=fields[e].value;r=cleanDigit(r,arrSymbols[e]),fields[e].value=r,arr[e]=textToNumber(fields[e].value,arrSymbols[e]),buttonAct()}))}function period(){counter=1;for(let e=0;e<arrFlag.length;e++)arrFlag[e]=1;for(let e=0;e<fields.length;e++)check(e),arrFlag[e]=1;reCalc()}function reCalc(){let e;overalValue=arr[0],interestRate=arr[1],monthPay=arr[2],overtime=Math.ceil(1e4*logab(1/(1-overalValue*rate(interestRate)/monthPay),1+rate(interestRate)))/1e4,(Number.isNaN(overtime)||overtime>monthLimit)&&(arr[2]=badNumber(),initLoop(),reCalc()),overtimePlus=Math.ceil(overtime),lastMonthPay=Math.ceil((overtime-Math.floor(overtime))*monthPay*100)/100,e=overtimePlus%12==0?"":`${overtimePlus%12} ${textMonth(parseInt(overtimePlus%12))}`,parseInt(overtimePlus/12)?elem.innerHTML=`${parseInt(overtimePlus/12)} ${textYear(parseInt(overtimePlus/12))} ${e}`:elem.innerHTML=`${e}`,document.getElementById("comment").innerHTML="(Месяцев: "+(overtimePlus-1)+" ) X ("+noBreak(numberToText(monthPay))+" ежемесячно)&nbsp;= "+noBreak(numberToText((overtimePlus-1)*monthPay,10))+". И&nbsp;последний платеж: "+noBreak(numberToText(Math.ceil(cent(lastMonthPay))))+". Переплата: "+noBreak(numberToText(Math.ceil(cent((overtimePlus-1)*monthPay+lastMonthPay-overalValue))))+". <br> При расчете значения всех трех полей корректируются в соответствие с граничными параметрами. <br>Если расчетное время превысит 25 лет, будет скорректировано значение в поле ЕЖЕМЕСЯЧНЫЙ ВЗНОС. <br>Из-за погрешности вычислений, итоговое значение округлено.",buttonDis()}function antidot(e){return e=String(e).replace(".",",")}function dot(e){return e=+String(e).replace(",",".")}function cent(e){return Math.ceil(100*e)/100}initLoop(),mainLoop(),reCalc();const btn=document.querySelector("button");function textYear(e){let t,r=e%100;return r>=5&&r<=20?t="лет":(r%=10,t=1==r?"год":r>=2&&r<=4?"года":"лет"),t}function textMonth(e){let t;return t=1==e?"месяц":e<=4?"месяца":"месяцев",t}function noBreak(e){return e=e.replace(/ /g,"&nbsp;")}function badNumber(){return monthPay=overalValue*(rate(interestRate)*(1+rate(interestRate))**monthLimit)/((1+rate(interestRate))**monthLimit-1),monthPay=Math.ceil(cent(monthPay)),monthPay}function buttonDis(){let e=document.querySelector(".press");e.setAttribute("disabled",!0),e.classList.add("nopress"),document.querySelector(".commenttext").classList.remove("fade")}function buttonAct(){let e=document.querySelector(".press");e.removeAttribute("disabled"),e.classList.remove("nopress"),document.querySelector(".commenttext").classList.add("fade")}function arbeit(e){if(arrFlag[e])return;checkout[e].innerHTML;let t=setInterval((()=>{checkout[e].classList.add("redalert"),checkout[e].innerHTML="проверка и коррекция значения через "+(counter-1)+" с",counter-=1,counter<=0&&(clearInterval(t),check(e),checkout[e].classList.remove("redalert"),checkout[e].innerHTML=formInitComment[e])}),1e3,e)}function check(e){arr[e]=textToNumber(fields[e].value,arrSymbols[e]),arr[e]=minmax(arrMin[e],arrMax[e],arr[e]),fields[e].value=numberToText(arr[e]),arrFlag[e]=1}btn.addEventListener("click",period);